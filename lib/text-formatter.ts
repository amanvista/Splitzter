import { Expense, Journey, Person } from '../types';
import { calculateJourneyBalance, getPersonExpensesSummary } from './calculations';

export interface ShareOptions {
  includeExpenses: boolean;
  includeBalances: boolean;
  includeSettlements: boolean;
  includeSummary: boolean;
}

export const formatJourneyForSharing = (
  journey: Journey,
  expenses: Expense[],
  options: ShareOptions = {
    includeExpenses: true,
    includeBalances: true,
    includeSettlements: true,
    includeSummary: true,
  }
): string => {
  const balance = calculateJourneyBalance(expenses, journey.participants);
  const lines: string[] = [];

  // Header
  lines.push(`ðŸŽ’ ${journey.name}`);
  if (journey.description) {
    lines.push(`ðŸ“ ${journey.description}`);
  }
  lines.push('');

  // Summary
  if (options.includeSummary) {
    lines.push('ðŸ“Š SUMMARY');
    lines.push('â”€'.repeat(20));
    lines.push(`ðŸ’° Total Expenses: $${balance.totalExpenses.toFixed(2)}`);
    lines.push(`ðŸ“‹ Number of Expenses: ${expenses.length}`);
    lines.push(`ðŸ‘¥ Participants: ${journey.participants.length}`);
    lines.push(`ðŸ“… Created: ${new Date(journey.createdAt).toLocaleDateString()}`);
    lines.push('');
  }

  // Expenses List
  if (options.includeExpenses && expenses.length > 0) {
    lines.push('ðŸ’¸ EXPENSES');
    lines.push('â”€'.repeat(20));
    
    expenses.forEach((expense, index) => {
      const paidByName = getPersonName(expense.paidBy, journey.participants);
      const splitNames = expense.splitBetween
        .map(id => getPersonName(id, journey.participants))
        .join(', ');
      
      lines.push(`${index + 1}. ${expense.title}`);
      lines.push(`   ðŸ’µ $${expense.amount.toFixed(2)}`);
      lines.push(`   ðŸ‘¤ Paid by: ${paidByName}`);
      lines.push(`   ðŸ”„ Split: ${splitNames}`);
      lines.push(`   ðŸ“… ${new Date(expense.date).toLocaleDateString()}`);
      if (expense.description) {
        lines.push(`   ðŸ“ ${expense.description}`);
      }
      lines.push('');
    });
  }

  // Individual Balances
  if (options.includeBalances) {
    lines.push('âš–ï¸ BALANCES');
    lines.push('â”€'.repeat(20));
    
    journey.participants.forEach(person => {
      const summary = getPersonExpensesSummary(expenses, person.id);
      const balanceAmount = balance.balances[person.id] || 0;
      
      lines.push(`ðŸ‘¤ ${person.name}`);
      lines.push(`   ðŸ’³ Paid: $${summary.totalPaid.toFixed(2)}`);
      lines.push(`   ðŸ§¾ Share: $${summary.totalShare.toFixed(2)}`);
      
      if (balanceAmount > 0.01) {
        lines.push(`   ðŸ”´ Owes: $${balanceAmount.toFixed(2)}`);
      } else if (balanceAmount < -0.01) {
        lines.push(`   ðŸŸ¢ Owed: $${Math.abs(balanceAmount).toFixed(2)}`);
      } else {
        lines.push(`   âœ… All settled`);
      }
      lines.push('');
    });
  }

  // Settlement Suggestions
  if (options.includeSettlements && balance.settlements.length > 0) {
    lines.push('ðŸ’¸ SUGGESTED PAYMENTS');
    lines.push('â”€'.repeat(20));
    
    balance.settlements.forEach((settlement, index) => {
      const fromName = getPersonName(settlement.from, journey.participants);
      const toName = getPersonName(settlement.to, journey.participants);
      lines.push(`${index + 1}. ${fromName} â†’ ${toName}: $${settlement.amount.toFixed(2)}`);
    });
    lines.push('');
  }

  // Footer
  lines.push('ðŸ“± Generated by Splitzter');
  lines.push(`ðŸ• ${new Date().toLocaleString()}`);

  return lines.join('\n');
};

export const formatExpenseListForSharing = (
  journey: Journey,
  expenses: Expense[]
): string => {
  const lines: string[] = [];

  lines.push(`ðŸ“‹ ${journey.name} - Expense List`);
  lines.push('');

  if (expenses.length === 0) {
    lines.push('No expenses recorded yet.');
    return lines.join('\n');
  }

  expenses.forEach((expense, index) => {
    const paidByName = getPersonName(expense.paidBy, journey.participants);
    const splitAmount = expense.amount / expense.splitBetween.length;
    
    lines.push(`${index + 1}. ${expense.title} - $${expense.amount.toFixed(2)}`);
    lines.push(`   Paid by ${paidByName}`);
    lines.push(`   $${splitAmount.toFixed(2)} per person`);
    lines.push('');
  });

  const totalAmount = expenses.reduce((sum, exp) => sum + exp.amount, 0);
  lines.push(`Total: $${totalAmount.toFixed(2)}`);

  return lines.join('\n');
};

export const formatSettlementsForSharing = (
  journey: Journey,
  expenses: Expense[]
): string => {
  const balance = calculateJourneyBalance(expenses, journey.participants);
  const lines: string[] = [];

  lines.push(`ðŸ’° ${journey.name} - Settlements`);
  lines.push('');

  if (balance.settlements.length === 0) {
    lines.push('ðŸŽ‰ Everyone is settled up!');
    return lines.join('\n');
  }

  lines.push('To settle all debts:');
  lines.push('');

  balance.settlements.forEach((settlement, index) => {
    const fromName = getPersonName(settlement.from, journey.participants);
    const toName = getPersonName(settlement.to, journey.participants);
    lines.push(`${index + 1}. ${fromName} pays ${toName} $${settlement.amount.toFixed(2)}`);
  });

  lines.push('');
  lines.push('After these payments, everyone will be even! âœ…');

  return lines.join('\n');
};

export const formatPersonalSummaryForSharing = (
  journey: Journey,
  expenses: Expense[],
  personId: string
): string => {
  const person = journey.participants.find(p => p.id === personId);
  if (!person) return 'Person not found';

  const summary = getPersonExpensesSummary(expenses, personId);
  const balance = calculateJourneyBalance(expenses, journey.participants);
  const personalBalance = balance.balances[personId] || 0;

  const lines: string[] = [];

  lines.push(`ðŸ‘¤ ${person.name}'s Summary`);
  lines.push(`ðŸŽ’ Journey: ${journey.name}`);
  lines.push('');

  lines.push('ðŸ’³ Your Payments:');
  const personalExpenses = expenses.filter(exp => exp.paidBy === personId);
  if (personalExpenses.length === 0) {
    lines.push('   No payments made');
  } else {
    personalExpenses.forEach(exp => {
      lines.push(`   â€¢ ${exp.title}: $${exp.amount.toFixed(2)}`);
    });
  }
  lines.push(`   Total Paid: $${summary.totalPaid.toFixed(2)}`);
  lines.push('');

  lines.push('ðŸ§¾ Your Share:');
  lines.push(`   Total Share: $${summary.totalShare.toFixed(2)}`);
  lines.push('');

  lines.push('âš–ï¸ Balance:');
  if (personalBalance > 0.01) {
    lines.push(`   ðŸ”´ You owe: $${personalBalance.toFixed(2)}`);
  } else if (personalBalance < -0.01) {
    lines.push(`   ðŸŸ¢ You are owed: $${Math.abs(personalBalance).toFixed(2)}`);
  } else {
    lines.push(`   âœ… You're all settled!`);
  }

  return lines.join('\n');
};

const getPersonName = (personId: string, participants: Person[]): string => {
  return participants.find(p => p.id === personId)?.name || 'Unknown';
};